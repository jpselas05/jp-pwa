<script>
const VAPID_PUBLIC = "BPH4cawsNXPd-sm-ycjGiZPAZot7RCuQ2UqpUA7mLtF7NtcS4lJs8lLoAQLZh5ey-xDc6ZcjXHdEXjnWRkhaE50"; // gerada no passo 1

// util para converter a chave VAPID
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const raw = atob(base64);
  const out = new Uint8Array(raw.length);
  for (let i = 0; i < raw.length; ++i) out[i] = raw.charCodeAt(i);
  return out;
}

async function enablePush() {
  if (!("serviceWorker" in navigator)) { alert("SW não suportado"); return; }
  if (!("PushManager" in window)) { alert("Push não suportado"); return; }

  // 1) registra o SW
  const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });

  // 2) pede permissão (no iOS só funciona se o app estiver instalado na Tela Inicial)
  const perm = await Notification.requestPermission();
  if (perm !== "granted") { alert("Permissão negada"); return; }

  // 3) cria a subscription
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
  });

  // 4) envia a subscription para teu servidor Node
  await fetch("https://TEU-SERVIDOR/subscriptions", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub)
  });

  alert("Inscrição de push registrada com sucesso!");
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("ativarPush");
  btn?.addEventListener("click", enablePush);
});
</script>

<button id="ativarPush">Ativar notificações</button>
