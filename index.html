<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision - Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/vision_icon.png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Bot√£o Ativar Notifica√ß√µes (canto superior) -->
    <button id="notifyBtn">üîî Ativar Notifica√ß√µes</button>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>Vision</h1>
            <p>Acompanhe suas movimenta√ß√µes em tempo real</p>
        </header>

        <!-- Stats Cards -->
        <section class="stats">
            <div class="stat-card entrada">
                <div class="icon">üì•</div>
                <div class="label">Entradas</div>
                <div class="value" id="totalEntradas">--</div>
            </div>
            <div class="stat-card saida">
                <div class="icon">üì§</div>
                <div class="label">Sa√≠das</div>
                <div class="value" id="totalSaidas">--</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="label">Saldo</div>
                <div class="value" id="saldo">--</div>
            </div>
        </section>

        <!-- Hist√≥rico -->
        <section class="historico">
            <div class="historico-header">
                <h2>Hist√≥rico de Transa√ß√µes</h2>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="entrada">Entradas</button>
                    <button class="filter-btn" data-filter="saida">Sa√≠das</button>
                </div>
            </div>
            <div id="transactionsList" class="transactions-list">
                <div class="loading">Carregando...</div>
            </div>
        </section>
    </div>

    <script type="module">
        import { checkIfSubscribed, enablePush, formatDate, formatCurrency, formatRelativeDate } from './js/app.js';
        import { getTransactions, getStats } from './js/api.js';

        let currentFilter = 'all';

        // ===== VERIFICAR SE J√Å TEM NOTIFICA√á√ÉO ATIVA =====
        async function checkNotifications() {
            const isSubscribed = await checkIfSubscribed();
            const btn = document.getElementById('notifyBtn');
            
            if (!isSubscribed) {
                btn.classList.add('show');
            }
        }

        // ===== ATIVAR NOTIFICA√á√ïES =====
        document.getElementById('notifyBtn').addEventListener('click', async () => {
            const btn = document.getElementById('notifyBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Ativando...';

            const result = await enablePush();

            if (result.success) {
                alert(result.message);
                btn.classList.remove('show');
            } else {
                alert('‚ùå ' + result.message);
                btn.disabled = false;
                btn.textContent = 'üîî Ativar Notifica√ß√µes';
            }
        });

        // ===== CARREGAR ESTAT√çSTICAS =====
        async function loadStats() {
            const stats = await getStats();
            
            document.getElementById('totalEntradas').textContent = `+${formatCurrency(stats.totalEntradas)}`;
            document.getElementById('totalSaidas').textContent = `-${formatCurrency(stats.totalSaidas)}`;
            document.getElementById('saldo').textContent = formatCurrency(stats.saldo);
        }

        // ===== CARREGAR TRANSA√á√ïES =====
        async function loadTransactions() {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '<div class="loading">Carregando...</div>';

            const filtros = currentFilter === 'all' ? {} : { tipo: currentFilter };
            const transactions = await getTransactions(filtros);

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty">Nenhuma transa√ß√£o encontrada</div>';
                return;
            }

            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-left">
                        <div class="transaction-icon ${t.tipo}">
                            ${t.tipo === 'entrada' ? 'üì•' : 'üì§'}
                        </div>
                        <div class="transaction-info">
                            <div class="tipo">${t.tipo === 'entrada' ? 'Entrada confirmada' : 'Sa√≠da registrada'}</div>
                            <div class="data">${formatRelativeDate(t.data)} √†s ${new Date(t.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    <div class="transaction-right">
                        <div class="valor ${t.tipo}">
                            ${t.tipo === 'entrada' ? '+' : '-'}${formatCurrency(t.valor)}
                        </div>
                        <div class="token">USDT</div>
                    </div>
                </div>
            `).join('');
        }

        // ===== FILTROS =====
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                loadTransactions();
            });
        });

        // ===== INICIALIZA√á√ÉO =====
        checkNotifications();
        loadStats();
        loadTransactions();

        // ===== LISTENER PARA MENSAGENS DO SERVICE WORKER =====
        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data.action === 'filter' && event.data.tipo) {
                // Aplica filtro quando clica na notifica√ß√£o
                const filterBtn = document.querySelector(`[data-filter="${event.data.tipo}"]`);
                if (filterBtn) {
                    filterBtn.click();
                }
            }
        });

        // ===== VERIFICAR FILTRO NA URL (para abrir diretamente) =====
        const urlParams = new URLSearchParams(window.location.search);
        const filterParam = urlParams.get('filter');
        if (filterParam && ['entrada', 'saida'].includes(filterParam)) {
            const filterBtn = document.querySelector(`[data-filter="${filterParam}"]`);
            if (filterBtn) {
                filterBtn.click();
            }
        }

        // ===== AUTO-REFRESH A CADA 30 SEGUNDOS =====
        setInterval(() => {
            loadStats();
            loadTransactions();
        }, 30000);
    </script>
</body>
</html>