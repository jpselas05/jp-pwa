<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision - Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/vision_icon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
        body{min-height:100vh;background:radial-gradient(circle at center,#0a0a0a 40%,#000 100%);color:#d4af37;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        #notifyBtn{position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#d4af37,#b88a2b);color:#000;border:none;padding:12px 24px;border-radius:50px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(212,175,55,.3);transition:all .3s;z-index:1000;display:none}
        #notifyBtn:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(212,175,55,.6)}
        #notifyBtn.show{display:block}
        header{text-align:center;margin-bottom:40px}
        header h1{font-size:3rem;letter-spacing:2px;text-shadow:0 0 10px rgba(212,175,55,.4);margin-bottom:10px}
        header p{color:#b99d34;font-size:1rem}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:40px}
        .stat-card{background:rgba(212,175,55,.05);border:1px solid rgba(212,175,55,.2);border-radius:16px;padding:24px;text-align:center;transition:all .3s}
        .stat-card:hover{transform:translateY(-5px);border-color:rgba(212,175,55,.4);box-shadow:0 8px 20px rgba(212,175,55,.1)}
        .stat-card .icon{font-size:2.5rem;margin-bottom:12px}
        .stat-card .label{color:#b99d34;font-size:.9rem;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .stat-card .value{font-size:2rem;font-weight:700;color:#d4af37}
        .stat-card.entrada .value{color:#4ade80}
        .stat-card.saida .value{color:#f87171}
        .historico{background:rgba(212,175,55,.05);border:1px solid rgba(212,175,55,.2);border-radius:16px;padding:24px}
        .historico-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .historico-header h2{font-size:1.5rem;color:#d4af37}
        .filters{display:flex;gap:8px}
        .filter-btn{background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);color:#d4af37;padding:8px 16px;border-radius:20px;font-size:14px;cursor:pointer;transition:all .3s}
        .filter-btn:hover,.filter-btn.active{background:#d4af37;color:#000;border-color:#d4af37}
        .transactions-list{display:flex;flex-direction:column;gap:12px}
        .transaction-item{background:rgba(255,255,255,.02);border:1px solid rgba(212,175,55,.1);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;transition:all .3s}
        .transaction-item:hover{background:rgba(212,175,55,.05);border-color:rgba(212,175,55,.3)}
        .transaction-left{display:flex;align-items:center;gap:16px}
        .transaction-icon{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
        .transaction-icon.entrada{background:rgba(74,222,128,.1);color:#4ade80}
        .transaction-icon.saida{background:rgba(248,113,113,.1);color:#f87171}
        .transaction-info .tipo{font-weight:600;margin-bottom:4px}
        .transaction-info .data{font-size:.85rem;color:#b99d34}
        .transaction-right{text-align:right}
        .transaction-right .valor{font-size:1.25rem;font-weight:700}
        .transaction-right .valor.entrada{color:#4ade80}
        .transaction-right .valor.saida{color:#f87171}
        .transaction-right .token{font-size:.85rem;color:#9b8326}
        .loading,.empty{text-align:center;padding:40px;color:#b99d34}
        @media (max-width:768px){
            header h1{font-size:2rem}
            .stats{grid-template-columns:1fr}
            .historico-header{flex-direction:column;align-items:stretch}
            .filters{width:100%;justify-content:center}
            .transaction-item{flex-direction:column;align-items:flex-start;gap:12px}
            .transaction-right{text-align:left}
            #notifyBtn{top:10px;right:10px;padding:10px 20px;font-size:13px}
        }
    </style>
</head>
<body>
    <button id="notifyBtn">üîî Ativar Notifica√ß√µes</button>
    <div class="container">
        <header>
            <h1>Vision</h1>
            <p>Acompanhe suas movimenta√ß√µes em tempo real</p>
        </header>
        <section class="stats">
            <div class="stat-card entrada">
                <div class="icon">üì•</div>
                <div class="label">Entradas</div>
                <div class="value" id="totalEntradas">--</div>
            </div>
            <div class="stat-card saida">
                <div class="icon">üì§</div>
                <div class="label">Sa√≠das</div>
                <div class="value" id="totalSaidas">--</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="label">Saldo</div>
                <div class="value" id="saldo">--</div>
            </div>
        </section>
        <section class="historico">
            <div class="historico-header">
                <h2>Hist√≥rico de Transa√ß√µes</h2>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">Todas</button>
                    <button class="filter-btn" data-filter="entrada">Entradas</button>
                    <button class="filter-btn" data-filter="saida">Sa√≠das</button>
                </div>
            </div>
            <div id="transactionsList" class="transactions-list">
                <div class="loading">Carregando...</div>
            </div>
        </section>
    </div>
    <script>
        const SERVER = "https://clavicular-vickey-furtively.ngrok-free.dev";
        const VAPID_PUBLIC = "BPH4cawsNXPd-sm-ycjGiZPAZot7RCuQ2UqpUA7mLtF7NtcS4lJs8lLoAQLZh5ey-xDc6ZcjXHdEXjnWRkhaE50";
        let currentFilter = 'all';

        function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
            const raw = atob(base64);
            const output = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
            return output;
        }

        async function checkIfSubscribed() {
            try {
                if (!('serviceWorker' in navigator)) return false;
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                return subscription !== null;
            } catch (error) {
                console.error('‚ùå Erro ao verificar subscription:', error);
                return false;
            }
        }

        async function enablePush() {
            const btn = document.getElementById('notifyBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Ativando...';
            
            try {
                const reg = await navigator.serviceWorker.register("sw.js");
                console.log("‚úÖ Service Worker registrado:", reg);

                const perm = await Notification.requestPermission();
                if (perm !== "granted") {
                    alert("Permiss√£o negada para notifica√ß√µes!");
                    btn.disabled = false;
                    btn.textContent = 'üîî Ativar Notifica√ß√µes';
                    return;
                }

                const sub = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
                });

                const res = await fetch(`${SERVER}/subscriptions`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify(sub)
                });

                if (res.ok) {
                    alert("üéâ Inscri√ß√£o feita com sucesso! Voc√™ j√° pode receber notifica√ß√µes.");
                    btn.classList.remove('show');
                } else {
                    alert("‚ùå Erro ao registrar a subscription no servidor.");
                    btn.disabled = false;
                    btn.textContent = 'üîî Ativar Notifica√ß√µes';
                }
            } catch (error) {
                console.error("‚ùå Erro geral:", error);
                alert("‚ùå Erro ao ativar notifica√ß√µes: " + error.message);
                btn.disabled = false;
                btn.textContent = 'üîî Ativar Notifica√ß√µes';
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${SERVER}/transactions/stats`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const data = await res.json();
                const stats = data.data || { totalEntradas: 0, totalSaidas: 0, saldo: 0 };
                
                document.getElementById('totalEntradas').textContent = `+${stats.totalEntradas.toFixed(2)}`;
                document.getElementById('totalSaidas').textContent = `-${stats.totalSaidas.toFixed(2)}`;
                document.getElementById('saldo').textContent = stats.saldo.toFixed(2);
            } catch (error) {
                console.error('‚ùå Erro ao carregar stats:', error);
            }
        }

        async function loadTransactions() {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '<div class="loading">Carregando...</div>';

            try {
                const params = currentFilter === 'all' ? '' : `?tipo=${currentFilter}`;
                const res = await fetch(`${SERVER}/transactions${params}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                const data = await res.json();
                const transactions = data.data || [];

                if (transactions.length === 0) {
                    container.innerHTML = '<div class="empty">Nenhuma transa√ß√£o encontrada</div>';
                    return;
                }

                container.innerHTML = transactions.map(t => {
                    const date = new Date(t.data);
                    const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    const timeStr = date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-left">
                                <div class="transaction-icon ${t.tipo}">
                                    ${t.tipo === 'entrada' ? 'üì•' : 'üì§'}
                                </div>
                                <div class="transaction-info">
                                    <div class="tipo">${t.tipo === 'entrada' ? 'Entrada confirmada' : 'Sa√≠da registrada'}</div>
                                    <div class="data">${dateStr} √†s ${timeStr}</div>
                                </div>
                            </div>
                            <div class="transaction-right">
                                <div class="valor ${t.tipo}">
                                    ${t.tipo === 'entrada' ? '+' : '-'}${t.valor.toFixed(2)}
                                </div>
                                <div class="token">USDT</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('‚ùå Erro ao carregar transa√ß√µes:', error);
                container.innerHTML = '<div class="empty">Erro ao carregar transa√ß√µes</div>';
            }
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                loadTransactions();
            });
        });

        document.getElementById('notifyBtn').addEventListener('click', enablePush);

        // Inicializa√ß√£o
        (async () => {
            const isSubscribed = await checkIfSubscribed();
            if (!isSubscribed) {
                document.getElementById('notifyBtn').classList.add('show');
            }
            loadStats();
            loadTransactions();
            setInterval(() => { loadStats(); loadTransactions(); }, 30000);
        })();
    </script>
</body>
</html>