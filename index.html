<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA Push Teste</title>
</head>

<body>
    <h1>ðŸš€ PWA Push Notification Test</h1>
    <p>Clique abaixo para ativar as notificaÃ§Ãµes:</p>
    <button id="ativar">Ativar NotificaÃ§Ãµes</button>

    <script>
        // ðŸ”— EndereÃ§o pÃºblico do teu servidor via ngrok
        const SERVER = "https://clavicular-vickey-furtively.ngrok-free.dev";
        // ðŸ”‘ Chave pÃºblica VAPID (a mesma do backend.js)
        const VAPID_PUBLIC = "BPH4cawsNXPd-sm-ycjGiZPAZot7RCuQ2UqpUA7mLtF7NtcS4lJs8lLoAQLZh5ey-xDc6ZcjXHdEXjnWRkhaE50";

        function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, "+")
                .replace(/_/g, "/");
            const raw = atob(base64);
            const output = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
            return output;
        }

        async function enablePush() {
            // 1ï¸âƒ£ Registra o Service Worker
            const reg = await navigator.serviceWorker.register("sw.js");
            console.log("âœ… Service Worker registrado:", reg);

            // 2ï¸âƒ£ Pede permissÃ£o ao usuÃ¡rio
            const perm = await Notification.requestPermission();
            if (perm !== "granted") {
                alert("PermissÃ£o negada para notificaÃ§Ãµes!");
                return;
            }

            // 3ï¸âƒ£ Cria a subscription com tua chave pÃºblica
            const sub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
            });

            // 4ï¸âƒ£ Envia a subscription pro servidor (ngrok)
            const res = await fetch(`${SERVER}/subscriptions`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(sub)
            });

            if (res.ok) {
                alert("ðŸŽ‰ InscriÃ§Ã£o feita com sucesso! Agora tu jÃ¡ pode receber notificaÃ§Ãµes.");
                console.log("Subscription registrada no servidor:", sub);
            } else {
                alert("âŒ Erro ao registrar a subscription no servidor.");
            }
        }

        document.getElementById("ativar").addEventListener("click", enablePush);
    </script>
</body>

</html>